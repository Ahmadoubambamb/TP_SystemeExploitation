#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <string.h>

#define bloc3 3
#define bloc4 4

void write_sequence(int tube, const char *sequence) {
    int len = strlen(sequence);
    for (int i = 0; i < len; i += bloc3) {
        write(tube, &sequence[i], bloc3);

       usleep(5000);
    }
    close(tube);
}

void read_from_tube(int tube) {
    char buffer[bloc4 + 1];
    int bytes_lu;
    while ((bytes_lu = read(tube, buffer, bloc4)) > 0) {
        buffer[bytes_lu] = '\0';
        printf("J'ai lu du tube : %s\n", buffer);
    }
    close(tube);
}

int main() {
    int tube[2];
    if (pipe(tube) == -1) {
        perror("Erreur de création du tube");
        exit(EXIT_FAILURE);
    }

    pid_t writer1, writer2, reader;

    // Premier écrivain : écrit "ABC...Z"
    writer1 = fork();
    if (writer1 == -1) {
        perror("Erreur de fork pour writer1");
        exit(EXIT_FAILURE);
    }
    if (writer1 == 0) {
        close(tube[0]); // Fermer la lecture
        write_sequence(tube[1], "ABCDEFGHIJKLMNOPQRSTUVWXYZ");
        exit(EXIT_SUCCESS);
    }

    // Deuxième écrivain : écrit "abc...z"
    writer2 = fork();
    if (writer2 == -1) {
        perror("Erreur de fork pour writer2");
        exit(EXIT_FAILURE);
    }
    if (writer2 == 0) {
        close(tube[0]); // Fermer la lecture
        write_sequence(tube[1], "abcdefghijklmnopqrstuvwxyz");
        exit(EXIT_SUCCESS);
    }

    // Lecteur : lit par blocs de 4 caractères
    reader = fork();
    if (reader == -1) {
        perror("Erreur de fork pour reader");
        exit(EXIT_FAILURE);
    }
    if (reader == 0) {
        close(tube[1]); // Fermer l'écriture
        read_from_tube(tube[0]);
        exit(EXIT_SUCCESS);
    }

    // Père
    close(tube[0]);
    close(tube[1]);

    // Attendre tous les fils
    wait(NULL);
    wait(NULL);
    wait(NULL);

    return 0;
}












// #include <stdio.h>
// #include <stdlib.h>
// #include <unistd.h>
// #include <sys/types.h>
//
// int main(){
//     pid_t fils1 , fils2 , fils3;
//
//     int tube[2];
//
//     if(pipe(tube) != 0){
//         perror("Pipe");
//         exit(1);
//     }
//
//     fils1 = fork();
//     if(fils == 0){
//
//         return EXIT_SUCCESS;
//     }
//
//     fils2 = fork();
//     if(fils == 0){
//
//         return EXIT_SUCCESS;
//     }
//
//     fils3 = fork();
//     if(fils == 0){
//
//         return EXIT_SUCCESS;
//     }
//
// }
